<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer" />
  <meta name="CocoaVersion" content="1344.72" />
  <style type="text/css">
    p.p2 {margin: 0.0px 0.0px 19.6px 0.0px; line-height: 17.8px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 17.8px}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 17.8px; font: 14.0px Arial; color: #333333; -webkit-text-stroke: #333333; min-height: 16.0px}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 17.8px; background-color: #fbfaf9}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; text-align: center; line-height: 17.8px}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 17.8px; font: 12.0px Arial; color: #000000; -webkit-text-stroke: #000000; min-height: 14.0px}
    p.p9 {margin: 0.0px 0.0px 19.6px 0.0px; line-height: 17.8px; font: 14.0px Consolas; color: #333333; -webkit-text-stroke: #333333; background-color: #fbfaf9; min-height: 16.0px}
    li.li3 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 17.8px}
    font.f1 {font: 18.0px Arial; font-kerning: none; color: #333333; -webkit-text-stroke: 0px #333333}
    font.f2 {font: 14.0px Arial; font-kerning: none; color: #333333; -webkit-text-stroke: 0px #333333}
    font.f3 {font: 14.0px Arial; color: #333333}
    font.f4 {font-kerning: none; color: #87000f; -webkit-text-stroke: 0px #87000f}
    font.f5 {font: 14.0px Consolas; font-kerning: none; color: #333333; background-color: #fbfaf9; -webkit-text-stroke: 0px #333333}
    font.f6 {font-kerning: none}
    font.f7 {font: 14.0px Consolas; font-kerning: none; color: #333333; -webkit-text-stroke: 0px #333333}
    font.f8 {font: 14.0px Consolas; font-kerning: none; color: #66cc66; -webkit-text-stroke: 0px #66cc66}
    font.f9 {font: 14.0px Consolas; font-kerning: none; color: #b1b100; -webkit-text-stroke: 0px #b1b100}
    font.f10 {font: 14.0px Consolas; font-kerning: none; color: #cc66cc; -webkit-text-stroke: 0px #cc66cc}
    font.f11 {font: 14.0px Consolas; font-kerning: none; color: #000066; -webkit-text-stroke: 0px #000066}
    font.f12 {font: 14.0px Consolas; font-kerning: none; color: #ff0000; -webkit-text-stroke: 0px #ff0000}
    font.f13 {font: 14.0px Consolas; font-kerning: none; color: #993333; -webkit-text-stroke: 0px #993333}
    font.f14 {font: 12.0px Arial; font-kerning: none; color: #000000; -webkit-text-stroke: 0px #000000}
    font.f15 {font: 14.0px Consolas; color: #333333; background-color: #fbfaf9}
    font.f16 {font: 12.0px Consolas; font-kerning: none; color: #333333; background-color: #fbfaf9; -webkit-text-stroke: 0px #333333}
    font.f17 {font: 14.0px Consolas; font-kerning: none; color: #808080; -webkit-text-stroke: 0px #808080}
    table.t1 {border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; border-collapse: collapse}
    td.td1 {width: 103.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td2 {width: 114.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td3 {width: 57.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td4 {width: 103.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td5 {width: 114.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td6 {width: 57.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td7 {width: 63.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td8 {width: 679.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td9 {width: 63.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td10 {width: 679.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td11 {width: 126.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td12 {width: 146.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td13 {width: 72.0px; background-color: #eeeeee; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td14 {width: 126.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td15 {width: 146.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    td.td16 {width: 72.0px; border-style: solid; border-width: 1.0px 1.0px 1.0px 1.0px; border-color: #cccccc #cccccc #cccccc #cccccc; padding: 3.6px 6.0px 3.6px 6.0px}
    ol.ol1 {list-style-type: decimal}
    ul.ul1 {list-style-type: square}
  </style>
</head>
<body>
<h2 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 21.0px"><font face="Arial" size="5" color="#333333" class="f1"><b>Lua Language</b></font></h2>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The nodeMCU firmware implements Lua 5.1 over the Espressif SDK for its ESP8266 SoC and the IoT modules based on this.</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The official lua.org <a href="http://www.lua.org/manual/5.1/manual.html"><font color="#87000f" class="f4"><b>Lua Language specification</b></font></a> gives a terse but complete language specification.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Its <a href="http://www.lua.org/faq.html"><font color="#87000f" class="f4">FAQ</font></a> provides information on Lua availability and licensing issues.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The <a href="http://www.luafaq.org/"><font color="#87000f" class="f4"><b>unofficial Lua FAQ</b></font></a> provides a lot of useful Q and A content, and is extremely useful for those learning Lua as a second language.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The <a href="http://lua-users.org/wiki/"><font color="#87000f" class="f4">Lua User's Wiki</font></a> gives useful example source and relevant discussion. In particular, its <a href="http://lua-users.org/wiki/Learning"><font color="#87000f" class="f4">Lua Learning Lua</font></a> section is a good place to start learning Lua.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The best book to learn Lua is <i>Programming in Lua</i> by Roberto Ierusalimschy, one of the creators of Lua. It's first edition is available free <a href="http://www.lua.org/pil/contents.html"><font color="#87000f" class="f4">online</font></a> . The second edition was aimed at Lua 5.1, but is out of print. The third edition is still in print and available in paperback. It contains a lot more material and clearly identifies Lua 5.1 vs Lua 5.2 differences. <b>This third edition is widely available for purchase and probably the best value for money</b>. References of the format [PiL <b>n.m</b>] refer to section <b>n.m</b> in this edition.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The Espressif ESP8266 architecture is closed source, but the Espressif SDK itself is continually being updated so the best way to get the documentation for this is to <a href="https://www.google.co.uk/search?q=Espressif+IoT+SDK+Programming+Guide"><font color="#87000f" class="f4">google Espressif IoT SDK Programming Guide</font></a> or to look at the Espressif <a href="http://bbs.espressif.com/viewforum.php?f=5"><font color="#87000f" class="f4">downloads forum</font></a> .<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The <a href="http://www.nodemcu.com/docs/"><font color="#87000f" class="f4"><b>nodeMCU documentation</b></font></a> is available online. However, please remember that the development team are based in China, and English is a second language, so the documentation needs expanding and be could improved with technical proofing.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">As with all Open Source projects the source for the nodeMCU firmware is openly available on the <a href="https://github.com/nodemcu/nodemcu-firmware"><font color="#87000f" class="f4">GitHub nodemcu-firmware</font></a> repository.<br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How is nodeMCU Lua different to standard Lua?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Whilst the Lua standard distribution includes a host stand-alone Lua interpreter, Lua itself is primarily an <i>extension language</i> that makes no assumptions about a “main” program: Lua works embedded in a host application to provide a powerful, light-weight scripting language for use within the application. This host application can then invoke functions to execute a piece of Lua code, can write and read Lua variables, and can register C functions to be called by Lua code. Through the use of C functions, Lua can be augmented to cope with a wide range of different domains, thus creating customized programming languages sharing a syntactical framework.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The ESP8266 was designed and is fabricated in China by <a href="http://espressif.com/new-sdk-release/"><font color="#87000f" class="f4">Espressif Systems</font></a>. Espressif have also developed and released a companion software development kit (SDK) to enable developers to build practical <a href="http://en.wikipedia.org/wiki/Internet%20of%20Things"><font color="#87000f" class="f4">IoT</font></a> applications for the ESP8266. The SDK is made freely available to developers in the form of binary libraries and SDK documentation. However this is in a <i>closed format</i>, with no developer access to the source files, so ESP8266 applications <i>must</i> rely solely on the SDK API (and the somewhat Spartan SDK API documentation).</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The nodeMCU Lua firmware is an ESP8266 application and must therefore be layered over the ESP8266 SDK. However, the hooks and features of Lua enable it to be seamlessly integrated without loosing any of the standard Lua language features. The firmware has replaced some standard Lua modules that don't align well with the SDK structure with ESP8266-specific versions. For example, the standard </font><font face="Consolas" size="4" color="#333333" class="f5">io</font><font face="Arial" size="4" color="#333333" class="f2"> and </font><font face="Consolas" size="4" color="#333333" class="f5">os</font><font face="Arial" size="4" color="#333333" class="f2"> libraries don't work, but have been largely replaced by the nodeMCU </font><font face="Consolas" size="4" color="#333333" class="f5">node</font><font face="Arial" size="4" color="#333333" class="f2"> and </font><font face="Consolas" size="4" color="#333333" class="f5">file</font><font face="Arial" size="4" color="#333333" class="f2"> libraries. The </font><font face="Consolas" size="4" color="#333333" class="f5">debug</font><font face="Arial" size="4" color="#333333" class="f2"> and </font><font face="Consolas" size="4" color="#333333" class="f5">math</font><font face="Arial" size="4" color="#333333" class="f2"> libraries have also been omitted to reduce the runtime footprint.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">NodeMCU Lua is based on <a href="http://www.eluaproject.net/overview"><font color="#87000f" class="f4">eLua</font></a>, a fully featured implementation of Lua 5.1 that has been optimized for embedded system development and execution to provide a scripting framework that can be used to deliver useful applications within the limited RAM and Flash memory resources of embedded processors such as the ESP8266. One of the main changes introduced in the eLua fork is to use read-only tables and constants wherever practical for library modules. On a typical build this approach reduces the RAM footprint by some 20-25KB and this makes a Lua implementation for the ESP8266 feasible. This technique is called LTR and this is documented in detail in an eLua technical paper: <a href="http://www.eluaproject.net/doc/master/en_arch_ltr.html"><font color="#87000f" class="f4">Lua Tiny RAM</font></a>.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The mains impacts of the ESP8266 SDK and together with its hardware resource limitations are not in the Lua language implementation itself, but in how <i>application programmers must approach developing and structuring their applications</i>. As discussed in detail below, the SDK is non-preemptive and event driven. Tasks can be associated with given events by using the SDK API to registering callback functions to the corresponding events. Events are queued internally within the SDK, and it then calls the associated tasks one at a time, with each task returning control to the SDK on completion. <i>The SDK states that if any tasks run for more than 10 mSec, then services such as Wifi can fail.</i></font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The nodeMCU libraries act as C wrappers around registered Lua callback functions to enable these to be used as SDK tasks. <b><i>You must therefore use an </i></b><a href="http://en.wikipedia.org/wiki/Event-driven%20programming"><font color="#87000f" class="f4"><b><i>Event-driven programming</i></b></font></a><b><i> style in writing your ESP8266 Lua programs</i></b>. Most programmers are used to writing in a procedural style where there is a clear single flow of execution, and the program interfaces to operating system services by a set of synchronous API calls to do network I/O, etc. Whilst the logic of each individual task is procedural, this is not how you code up ESP8266 applications.</font></p>
<h2 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 21.0px"><font face="Arial" size="5" color="#333333" class="f1"><b>ESP8266 Specifics</b></font></h2>
<p class="p5"><font class="f6"></font><br /></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How is coding for the ESP8266 the same as standard Lua?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">This is a fully featured Lua 5.1 implementation so all standard Lua language constructs and data types work.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The main standard Lua libraries – </font><font face="Consolas" size="4" color="#333333" class="f5">core</font><font face="Arial" size="4" color="#333333" class="f2">, </font><font face="Consolas" size="4" color="#333333" class="f5">coroutine</font><font face="Arial" size="4" color="#333333" class="f2">, </font><font face="Consolas" size="4" color="#333333" class="f5">string</font><font face="Arial" size="4" color="#333333" class="f2"> and </font><font face="Consolas" size="4" color="#333333" class="f5">table</font><font face="Arial" size="4" color="#333333" class="f2"> are implemented.<br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How is coding for the ESP8266 different to standard Lua?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The ESP8266 use onchip RAM and offchip Flash memory connected using a dedicated SPI interface. Both of these are <i>very</i> limited (when compared to systems than most application programmer use). The SDK and the Lua firmware already use the majority of this resource: the later build versions keep adding useful functionality, and unfortunately at an increased RAM and Flash cost, so depending on the build version and the number of modules installed the runtime can have as little as 17KB RAM and 40KB Flash available at an application level. This Flash memory is formatted an made available as a <b>SPI Flash File System (SPIFFS)</b> through the </font><font face="Consolas" size="4" color="#333333" class="f5">file</font><font face="Arial" size="4" color="#333333" class="f2">library.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">However, if you choose to use a custom build, for example one which uses integer arithmetic instead of floating point, and which omits libraries that aren't needed for your application, then this can help a lot doubling these available resources. (See Marcel Stör's excellent <a href="http://frightanic.com/nodemcu-custom-build/"><font color="#87000f" class="f4">custom build tool</font></a> that he discusses in <a href="http://www.esp8266.com/viewtopic.php?f=23&amp;t=3001"><font color="#87000f" class="f4">this forum topic</font></a>). Even so, those developers who are used to dealing in MB or GB of RAM and file systems can easily run out of these resources. Some of the techniques discussed below can go a long way to mitigate this issue.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Current versions of the ESP8266 run the SDK over the native hardware so there is no underlying operating system to capture errors and to provide graceful failure modes, so system or application errors can easily “PANIC” the system causing it to reboot. Error handling has been kept simple to save on the limited code space, and this exacerbates this tendency. Running out of a system resource such as RAM will invariably cause a messy failure and system reboot.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">There is currently no </font><font face="Consolas" size="4" color="#333333" class="f5">debug</font><font face="Arial" size="4" color="#333333" class="f2"> library support. So you have to use 1980s-style “binary-chop” to locate errors and use print statement diagnostics though the systems UART interface. (This omission was largely because of the Flash memory footprint of this library, but there is no reason in principle why we couldn't make this library available in the near future as an custom build option).<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The LTR implementation means that you can't easily extend standard libraries as you can in normal Lua, so for example an attempt to define </font><font face="Consolas" size="4" color="#333333" class="f5">function table.pack()</font><font face="Arial" size="4" color="#333333" class="f2"> will cause a runtime error because you can't write to the global </font><font face="Consolas" size="4" color="#333333" class="f5">table</font><font face="Arial" size="4" color="#333333" class="f2">. (Yes, there are standard sand-boxing techniques to achieve the same effect by using metatable based inheritance, but if you try to use this type of approach within a real application, then you will find that you run out of RAM before you implement anything useful.)<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">There are standard libraries to provide access to the various hardware options supported by the hardware: WiFi, GPIO, One-wire, I²C, SPI, ADC, PWM, UART, etc.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The runtime system runs in interactive-mode. In this mode it first executes any </font><font face="Consolas" size="4" color="#333333" class="f5">init.lua</font><font face="Arial" size="4" color="#333333" class="f2"> script. It then “listens” to the serial port for input Lua chunks, and executes them once syntactically complete. There is no </font><font face="Consolas" size="4" color="#333333" class="f5">luac</font><font face="Arial" size="4" color="#333333" class="f2"> or batch support, although automated embedded processing is normally achieved by setting up the necessary event triggers in the </font><font face="Consolas" size="4" color="#333333" class="f5">init.lua</font><font face="Arial" size="4" color="#333333" class="f2"> script.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The various libraries (</font><font face="Consolas" size="4" color="#333333" class="f5">net</font><font face="Arial" size="4" color="#333333" class="f2">, </font><font face="Consolas" size="4" color="#333333" class="f5">tmr</font><font face="Arial" size="4" color="#333333" class="f2">, </font><font face="Consolas" size="4" color="#333333" class="f5">wifi</font><font face="Arial" size="4" color="#333333" class="f2">, etc.) use the SDK callback mechanism to bind Lua processing to individual events (for example a timer alarm firing). Developers should make full use of these events to keep Lua execution sequences short. <i>If any individual task takes too long to execute then other queued tasks can time-out and bad things start to happen.</i><br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Non-Lua processing (e.g. network functions) will usually only take place once the current Lua chunk has completed execution. So any network calls should be viewed at an asynchronous request. A common coding mistake is to assume that they are synchronous, that is if two </font><font face="Consolas" size="4" color="#333333" class="f5">socket:send()</font><font face="Arial" size="4" color="#333333" class="f2"> are on consecutive lines in a Lua programme, then the first has completed by the time the second is executed. This is wrong. Each </font><font face="Consolas" size="4" color="#333333" class="f5">socket:send()</font><font face="Arial" size="4" color="#333333" class="f2"> request simply queues the send operation for dispatch. Neither will start to process until the Lua code has return to is calling C function. Stacking up such requests in a single Lua task function burns scarce RAM and can trigger a PANIC. This true for timer, network, and other callbacks. It is even the case for actions such as requesting a system restart, as can be seen by the following example:<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>node</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">restart</font><font face="Consolas" size="4" color="#66cc66" class="f8">();</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">for</font><font face="Consolas" size="4" color="#333333" class="f7"> i </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#cc66cc" class="f10">1</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#cc66cc" class="f10">20</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">do</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">print</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"not quite yet -- "</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7">i</font><font face="Consolas" size="4" color="#66cc66" class="f8">);</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">You therefore <i>have</i> to implement ESP8266 Lua applications using an event driven approach. You have to understand which SDK API requests schedule asynchronous processing, and which define event actions through Lua callbacks. Yes, such an event-driven approach makes it difficult to develop procedurally structured applications, but it is well suited to developing the sorts of application that you will typically want to implement on an <a href="http://en.wikipedia.org/wiki/Internet%20of%20Things"><font color="#87000f" class="f4">IoT</font></a> device.<br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>So how does the SDK event / tasking system work in Lua?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The SDK employs an event-driven and task-oriented architecture for programming at an applications level.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The SDK uses a startup hook </font><font face="Consolas" size="4" color="#333333" class="f5">void user_init(void)</font><font face="Arial" size="4" color="#333333" class="f2">, defined by convention in the C module </font><font face="Consolas" size="4" color="#333333" class="f5">user_main.c</font><font face="Arial" size="4" color="#333333" class="f2">, which it invokes on boot. The </font><font face="Consolas" size="4" color="#333333" class="f5">user_init()</font><font face="Arial" size="4" color="#333333" class="f2"> function can be used to do any initialisation required and to call the necessary timer alarms or other SDK API calls to bind and callback routines to implement the tasks needed in response to any system events.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The API provides a set of functions for declaring application functions (written in C) as callbacks to associate application tasks with specific hardware and timer events. These are non-preemptive at an applications level.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Whilst the SDK provides a number of interrupt driven device drivers, the hardware architecture severely limits the memory available for these drivers, so writing new device drivers is not a viable options for most developers<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The SDK interfaces internally with hardware and device drivers to queue pending events.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The registered callback routines are invoked sequentially with the associated C task running to completion uninterrupted.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">In the case of Lua, these C tasks are typically functions within the Lua runtime library code and these typically act as C wrappers around the corresponding developer-provided Lua callback functions. An example here is the Lua </font><font face="Consolas" size="4" color="#333333" class="f5">tmr.alarm(id, interval, repeat, callback)</font><font face="Arial" size="4" color="#333333" class="f2"> function. The calls a function in the </font><font face="Consolas" size="4" color="#333333" class="f5">tmr</font><font face="Arial" size="4" color="#333333" class="f2">library which registers a C function for this alarm using the SDK, and when this C function is called it then invokes the Lua callback.<br />
</font></li>
</ul>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The nodeMCU firmware simply mirrors this structure at a Lua scripting level:</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">A startup module </font><font face="Consolas" size="4" color="#333333" class="f5">init.lua</font><font face="Arial" size="4" color="#333333" class="f2"> is invoked on boot. This function module can be used to do any initialisation required and to call the necessary timer alarms or libary calls to bind and callback routines to implement the tasks needed in response to any system events.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The Lua libraries provide a set of functions for declaring application functions (written in Lua) as callbacks (which are stored in the <a href="http://www.esp8266.com/wiki/doku.php?id=nodemcu-unofficial-faq#so_how_is_the_lua_registry_used_and_why_is_this_important"><font color="#87000f" class="f4">Lua registry</font></a>) to associate application tasks with specific hardware and timer events. These are non-preemptive at an applications level.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The Lua libraries work in consort with the SDK to queue pending events and invoke any registered Lua callback routines, which then run to completion uninterrupted.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Excessively long-running Lua functions can therefore cause other system functions and services to timeout, or allocate memory to buffer queued data, which can then trigger either the watchdog timer or memory exhaustion, both of which will ultimately cause the system to reboot.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">By default, the Lua runtime also 'listens' to UART 0, the serial port, in interactive mode and will execute any Lua commands input through this serial port.<br />
</font></li>
</ul>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">This event-driven approach is very different to a conventional procedural implementation of Lua.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Consider a simple telnet example given in </font><font face="Consolas" size="4" color="#333333" class="f5">examples/fragment.lua</font><font face="Arial" size="4" color="#333333" class="f2">:</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>s</font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">createServer</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">TCP</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>s</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">listen</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#cc66cc" class="f10">23</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span>con_std </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> c<span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#333333" class="f7"> s_output</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">str</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">     </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">if</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">con_std</font><font face="Consolas" size="4" color="#66cc66" class="f8">~=</font><font face="Consolas" size="4" color="#993333" class="f13">nil</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">then</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">       </span>con_std</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">send</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">str</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">     </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span>node</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">output</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">s_output</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#cc66cc" class="f10">0</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span>c</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">on</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"receive"</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7">l</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> node</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">input</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">l</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span>c</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">on</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"disconnection"</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">     </span>con_std </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#993333" class="f13">nil</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">     </span>node</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">output</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#993333" class="f13">nil</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">   </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">This example defines five Lua functions:</font></p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td1">
        <p align="center" class="p7"><font face="Arial" size="3" color="#000000" class="f14"><b>Function</b></font></p>
      </td>
      <td valign="top" class="td1">
        <p align="center" class="p7"><font face="Arial" size="3" color="#000000" class="f14"><b>Defined in</b></font></p>
      </td>
      <td valign="top" class="td2">
        <p align="center" class="p7"><font face="Arial" size="3" color="#000000" class="f14"><b>Parameters</b></font></p>
      </td>
      <td valign="top" class="td3">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14"><b>Callback?</b></font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Main</font></p>
      </td>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Outer module</font></p>
      </td>
      <td valign="top" class="td5">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">… (Not used)</font></p>
      </td>
      <td valign="top" class="td6">
        <p class="p8"><font class="f6"></font><br /></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Connection listener</font></p>
      </td>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Main</font></p>
      </td>
      <td valign="top" class="td5">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">c (connection socket)</font></p>
      </td>
      <td valign="top" class="td6">
        <p class="p8"><font class="f6"></font><br /></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">s_output</font></p>
      </td>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Connection listener</font></p>
      </td>
      <td valign="top" class="td5">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">str</font></p>
      </td>
      <td valign="top" class="td6">
        <p align="center" class="p7"><font face="Arial" size="3" color="#000000" class="f14">Yes</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">On Receive</font></p>
      </td>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Connection listener</font></p>
      </td>
      <td valign="top" class="td5">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">c, l (socket, input)</font></p>
      </td>
      <td valign="top" class="td6">
        <p align="center" class="p7"><font face="Arial" size="3" color="#000000" class="f14">Yes</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">On Disconnect</font></p>
      </td>
      <td valign="top" class="td4">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">Connection listener</font></p>
      </td>
      <td valign="top" class="td5">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">c (socket)</font></p>
      </td>
      <td valign="top" class="td6">
        <p align="center" class="p7"><font face="Arial" size="3" color="#000000" class="f14">Yes</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p9"><font class="f6"></font><br /></p>
<p class="p2"><font face="Consolas" size="4" color="#333333" class="f5">s</font><font face="Arial" size="4" color="#333333" class="f2">, </font><font face="Consolas" size="4" color="#333333" class="f5">con_std</font><font face="Arial" size="4" color="#333333" class="f2"> and </font><font face="Consolas" size="4" color="#333333" class="f5">s_output</font><font face="Arial" size="4" color="#333333" class="f2"> are global, and no <a href="http://www.esp8266.com/wiki/doku.php?id=nodemcu-unofficial-faq#why_is_it_importance_to_understand_how_upvalues_are_implemented_when_programming_for_the_esp8266"><font color="#87000f" class="f4">upvalues</font></a> are used. There is no “correct” order to define these in, but we could reorder this code for clarity (though doing this adds a few extra globals) and define these functions separately one another. However, let us consider how this is executed:</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The outer module is compiled including the four internal functions.<br />
</font></li>
  <li class="li3"><font face="Consolas" size="4" color="#333333" class="f15"></font><font face="Consolas" size="4" color="#333333" class="f5">Main</font><font face="Arial" size="4" color="#333333" class="f2"> is then assigning the created </font><font face="Consolas" size="4" color="#333333" class="f5">net.createServer()</font><font face="Arial" size="4" color="#333333" class="f2"> to the global </font><font face="Consolas" size="4" color="#333333" class="f5">s</font><font face="Arial" size="4" color="#333333" class="f2">. The </font><font face="Consolas" size="4" color="#333333" class="f5">connection listener</font><font face="Arial" size="4" color="#333333" class="f2"> closure is created and bound to a temporary variable which is then passed to the </font><font face="Consolas" size="4" color="#333333" class="f5">socket.listen()</font><font face="Arial" size="4" color="#333333" class="f2"> as an argument. The routine then exits returning control to the firmware.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">When another computer connects to port 23, the listener handler retrieves the reference to then connection listener and calls it with the socket parameter. This function then binds the s_output closure to the global </font><font face="Consolas" size="4" color="#333333" class="f5">s_output</font><font face="Arial" size="4" color="#333333" class="f2">, and registers this function with the </font><font face="Consolas" size="4" color="#333333" class="f5">node.output</font><font face="Arial" size="4" color="#333333" class="f2"> hook. Likewise the </font><font face="Consolas" size="4" color="#333333" class="f5">on receive</font><font face="Arial" size="4" color="#333333" class="f2"> and </font><font face="Consolas" size="4" color="#333333" class="f5">on disconnection</font><font face="Arial" size="4" color="#333333" class="f2"> are bound to temporary variables which are passed to the respective on handlers. We now have four Lua function registered in the Lua runtime libraries associated with four events. This routine then exits returning control to the firmware.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">When a record is received, the on receive handler within the net library retrieves the reference to the </font><font face="Consolas" size="4" color="#333333" class="f5">on receive</font><font face="Arial" size="4" color="#333333" class="f2"> Lua function and calls it passing it the record. This routine then passes this to the </font><font face="Consolas" size="4" color="#333333" class="f5">node.input()</font><font face="Arial" size="4" color="#333333" class="f2"> and exits returning control to the firmware.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The </font><font face="Consolas" size="4" color="#333333" class="f5">node.input</font><font face="Arial" size="4" color="#333333" class="f2"> handler polls on an 80 mSec timer alarm. If a compete Lua chunk is available (either via the serial port or node input function), then it executes it and any output is then passed to the </font><font face="Consolas" size="4" color="#333333" class="f5">note.output</font><font face="Arial" size="4" color="#333333" class="f2"> handler. which calls </font><font face="Consolas" size="4" color="#333333" class="f5">s_output</font><font face="Arial" size="4" color="#333333" class="f2"> function. Any pending sends are then processed.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">This cycle repeats until the other computer disconnects, and </font><font face="Consolas" size="4" color="#333333" class="f5">net</font><font face="Arial" size="4" color="#333333" class="f2"> library disconnection handler then calls the Lua </font><font face="Consolas" size="4" color="#333333" class="f5">on disconnect</font><font face="Arial" size="4" color="#333333" class="f2"> handler. This Lua routine dereferences the connected socket and closes the </font><font face="Consolas" size="4" color="#333333" class="f5">node.output</font><font face="Arial" size="4" color="#333333" class="f2"> hook and exits returning control to the disconnect handler which garbage collects any associated sockets and registered on handlers.<br />
</font></li>
</ul>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Whilst this is all going on, The SDK can (and often will) schedule other event tasks in between these Lua executions (e.g. to do the actual TCP stack processing). The longest individual Lua execution in this example is only 18 bytecode instructions (in the main routine).</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Understanding how the system executes your code can help you structure it better and improve memory usage. Each event task is established by a callback in an API call in an earlier task.</font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>So what Lua library functions enable the registration of Lua callbacks?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">SDK Callbacks include:</font></p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td7">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14"><b>Lua Module</b></font></p>
      </td>
      <td valign="top" class="td8">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14"><b>Functions which define or remove callbacks</b></font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">tmr</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">alarm(id, interval, repeat, function())</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">node</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">key(type, function())</font><font face="Arial" size="3" color="#000000" class="f14">, </font><font face="Consolas" size="3" color="#333333" class="f16">output(function(str), serial_debug)</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">wifi</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">startsmart(chan, function())</font><font face="Arial" size="3" color="#000000" class="f14">, </font><font face="Consolas" size="3" color="#333333" class="f16">sta.getap(function(table))</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">net.server</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">sk:listen(port,[ip],function(socket))</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">net</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">sk:on(event, function(socket, [, data]))</font><font face="Arial" size="3" color="#000000" class="f14">, </font><font face="Consolas" size="3" color="#333333" class="f16">sk:send(string, function(sent))</font><font face="Arial" size="3" color="#000000" class="f14">, </font><font face="Consolas" size="3" color="#333333" class="f16">sk:dns(domain, function(socket,ip))</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">gpio</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">trig(pin, type, function(level))</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">mqqt</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">client:m:on(event, function(conn[, topic, data])</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td9">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">uart</font></p>
      </td>
      <td valign="top" class="td10">
        <p class="p3"><font face="Consolas" size="3" color="#333333" class="f16">uart.on(event, cnt, [function(data)], [run_input])</font></p>
      </td>
    </tr>
  </tbody>
</table>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px; font: 14.0px Arial; color: #333333; -webkit-text-stroke: #333333; min-height: 16.0px"><font class="f6"><b></b></font><br /></h3>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>So how is context passed between Lua event tasks?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">It is important to understand that any event callback task is associated with a single Lua function. This function is executed from the relevant nodeMCU library C code using a </font><font face="Consolas" size="4" color="#333333" class="f5">lua_call()</font><font face="Arial" size="4" color="#333333" class="f2">. Even system initialisation which executes the </font><font face="Consolas" size="4" color="#333333" class="f5">dofile(“init.lua”)</font><font face="Arial" size="4" color="#333333" class="f2"> can be treated as a special case of this. Each function can invoke other functions and so on, but it must ultimate return control to the C library code.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">By their very nature Lua </font><font face="Consolas" size="4" color="#333333" class="f5">local</font><font face="Arial" size="4" color="#333333" class="f2"> variables only exist within the context of an executing Lua function, and so all locals are destroyed between these </font><font face="Consolas" size="4" color="#333333" class="f5">lua_call()</font><font face="Arial" size="4" color="#333333" class="f2">actions. <i>No locals are retained across events</i>.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">So context can only be passed between event routines by one of three mechanisms:</font></li>
  <ul class="ul1">
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"><b></b></font><font face="Arial" size="4" color="#333333" class="f2"><b>Globals</b> are by nature globally accessible. Any global will persist until explicitly dereference by reassigning </font><font face="Consolas" size="4" color="#333333" class="f5">nil</font><font face="Arial" size="4" color="#333333" class="f2"> to it. Globals can be readily enumerated by a </font><font face="Consolas" size="4" color="#333333" class="f5">for k,v in pairs(_G) do</font><font face="Arial" size="4" color="#333333" class="f2"> so their use is transparent.<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The <b>File system</b> is a special case of persistent global, so there is no reason in principle why it can't be used to pass context. However the ESP8266 file system uses flash memory and this has a limited write cycle lifetime, so it is best to avoid using the file system to store frequently changing content except as a mechanism of last resort.<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"><b></b></font><font face="Arial" size="4" color="#333333" class="f2"><b>Upvalues</b>. When a function is declared within an outer function, all of the local variables in the outer scope are available to the inner function. Since all functions are stored by reference the scope of the inner function might outlast the scope of the outer function, and the Lua runtime system ensures that any such references persist for the life of any functions that reference it. This standard feature of Lua is known as <i>closure</i> and is described in [Pil 6]. Such values are often called<i>upvalues</i>. Functions which are global or <a href="http://www.esp8266.com/wiki/doku.php?id=nodemcu-unofficial-faq#so_how_is_the_lua_registry_used_and_why_is_this_important"><font color="#87000f" class="f4">registered</font></a> callbacks will persist between event routines, and hence any upvalues referenced by them can be used for passing context.<br />
</font></li>
  </ul>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>So how is the Lua Registry used and why is this important?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">So all Lua callbacks are called by C wrapper functions that are themselves callback activated by the SDK as a result of a given event. Such C wrapper functions themselves frequently need to store state for passing between calls or to other wrapper C functions. The Lua registry is simply another Lua table which is used for this purpose, except that it is hidden from direct Lua access. Any content that needs to be saved is created with a unique key. Using a standard Lua table enables standard garbage collection algorithms to operate on its content.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Note that we have identified a number of cases where library code does not correctly clean up Registry content when closing out an action, leading to memory leaks.</font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>Why is it importance to understand how upvalues are implemented when programming for the ESP8266?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Routines directly or indirectly referenced in the globals table, <b>_G</b>, or in the Lua Registry may use upvalues. The number of upvalues associated with a given routine is determined by the compiler and a vector is allocated when the closure is bound to hold these references. Each upvalues is classed as open or closed. All upvalues are initially open which means that the upvalue references back to the outer functions's register set. However, upvalues must be able to outlive the scope of the outer routine where they are declared as a local variable. The runtime VM does this by adding extra checks when executing a function return to scan any defined closures within its scope for back references and allocate memory to hold the upvalue and points the upvalue's reference to this. This is known as a closed upvalue.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">This processing is a mature part of the Lua 5.x runtime system, and for normal Lua applications development this “behind-the-scenes” magic ensures that upvalues just work as any programmer might expect. Sufficient garbage collector metadata is also stored so that these hidden values will be garbage collected correctly <i>when properly dereferenced</i>. However allocating these internal structures is quite expensive in terms of memory, and this hidden overhead is hard to track or to understand. If you are developing a Lua application for a PC where the working RAM for an application is measured in MB, then this isn't really an issue. However, if you are developing an application for the ESP8266 where you might have 20 KB for your program and data, this could prove a killer.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">One further complication is that some library functions don't correctly dereference expired callback references and as a result their upvalues may not be correctly garbage collected (though we are tracking this down and hopefully removing this issue). This will all be manifested as a memory leak. So using upvalues can cause more frequent and difficult to diagnose PANICs during testing. So my general recommendation is still to stick to globals for this specific usecase of passing context between event callbacks, and </font><font face="Consolas" size="4" color="#333333" class="f5">nil</font><font face="Arial" size="4" color="#333333" class="f2"> them when you have done with them.</font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>Can I encapsulate actions such as sending an email in a Lua function?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Think about the implications of these last few answers.</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">An action such as composing and sending an email involves a message dialogue with a mail server over TCP. This in turn requires calling multiple API calls to the SDK and your Lua code must return control to the C calling library for this to be scheduled, otherwise these requests will just queue up, you'll run out of RAM and your application will PANIC.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Hence it is simply <b><i>impossible</i></b> to write a Lua module so that you can do something like:<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- prepare message</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span>status </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> mail</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">send</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">to</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> subject</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> body</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- move on to next phase of processing.</i></font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">But you could code up a event-driven task to do this and pass it a callback to be executed on completion of the mail send, something along the lines of the following. Note that since this involves a lot of asynchronous processing and which therefore won't take place until you've returned control to the calling library C code, you will typically execute this as the last step in a function and therefore this is best done as a tailcall [PiL 6.3].<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- prepare message</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> ms </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">require</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"mail_sender"</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">return</font><font face="Consolas" size="4" color="#333333" class="f7"> ms</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">send</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">to</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> subject</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> body</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">status</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">loadfile</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"process_next.lua"</font><font face="Consolas" size="4" color="#66cc66" class="f8">)(</font><font face="Consolas" size="4" color="#333333" class="f7">status</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Building an application on the ESP8266 is a bit like threading pearls onto a necklace. Each pearl is an event task which must be small enough to run within its RAM resources and the string is the variable context that links the pearls together.<br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>When and why should I avoid using tmr.delay()?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">If you are used coding in a procedural paradigm then it is understandable that you consider using </font><font face="Consolas" size="4" color="#333333" class="f5">tmr.delay()</font><font face="Arial" size="4" color="#333333" class="f2"> to time sequence your application. However as discussed in the previous section, with nodeMCU Lua you are coding in an event-driven paradigm.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">If you look at the </font><font face="Consolas" size="4" color="#333333" class="f5">app/modules/tmr.c</font><font face="Arial" size="4" color="#333333" class="f2"> code for this function, then you will see that it executes a low level </font><font face="Consolas" size="4" color="#333333" class="f5">ets_delay_us(delay)</font><font face="Arial" size="4" color="#333333" class="f2">. This function isn't part of the nodeMCU code or the SDK; it's actually part of the xtensa-lx106 boot ROM, and is a simple timing loop which polls against the internal CPU clock. It does this with interrupts disabled, because if they are enabled then there is no guarantee that the delay will be as requested.</font></p>
<p class="p2"><font face="Consolas" size="4" color="#333333" class="f5">tmr.delay()</font><font face="Arial" size="4" color="#333333" class="f2"> is really intended to be used where you need to have more precise timing control on an external hardware I/O (e.g. lifting a GPIO pin high for 20 μSec). It will achieve no functional purpose in pretty much every other usecase, as any other system code-based activity will be blocked from execution; at worst it will break your application and create hard-to-diagnose timeout errors.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The latest SDK includes a caution that if any (callback) task runs for more than 10 mSec, then the Wifi and TCP stacks might fail, so if you want a delay of more than 8 mSec or so, then <i>using </i></font><font face="Consolas" size="4" color="#333333" class="f5"><i>tmr.delay()</i></font><font face="Arial" size="4" color="#333333" class="f2"><i> is the wrong approach</i>. You should be using a timer alarm or another library callback, to allow the other processing to take place. As the nodeMCU documentation correctly advises (translating Chinese English into English): </font><font face="Consolas" size="4" color="#333333" class="f5"><i>tmr.delay()</i></font><font face="Arial" size="4" color="#333333" class="f2"><i> will make the CPU work in non-interrupt mode, so other instructions and interrupts will be blocked. Take care in using this function.</i></font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How do I avoid a PANIC loop in init.lua?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Most of us have fallen into the trap of creating an </font><font face="Consolas" size="4" color="#333333" class="f5">init.lua</font><font face="Arial" size="4" color="#333333" class="f2"> that has a bug in it, which then causes the system to reboot and hence gets stuck in a reboot loop. If you haven't then you probably will do so at least once.</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">When this happens, the only robust solution is to reflash the firmware.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The simplest way to avoid having to do this is to keep the </font><font face="Consolas" size="4" color="#333333" class="f5">init.lua</font><font face="Arial" size="4" color="#333333" class="f2"> as simple as possible – say configure the wifi and then start your app using a one-time</font><font face="Consolas" size="4" color="#333333" class="f5">tmr.alarm()</font><font face="Arial" size="4" color="#333333" class="f2"> after a 2-3 sec delay. This delay is long enough to issue a </font><font face="Consolas" size="4" color="#333333" class="f5">file.remove(“init.lua”)</font><font face="Arial" size="4" color="#333333" class="f2"> through the serial port and recover control that way.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Also it is always best to test any new </font><font face="Consolas" size="4" color="#333333" class="f5">init.lua</font><font face="Arial" size="4" color="#333333" class="f2"> by creating it as </font><font face="Consolas" size="4" color="#333333" class="f5">init_test.lua</font><font face="Arial" size="4" color="#333333" class="f2">, say, and manually issuing a </font><font face="Consolas" size="4" color="#333333" class="f5">dofile(“init_test.lua”)</font><font face="Arial" size="4" color="#333333" class="f2"> through the serial port, and then only rename it when you are certain it is working as you require.<br />
</font></li>
</ul>
<h2 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 21.0px"><font face="Arial" size="5" color="#333333" class="f1"><b>Techniques for Reducing RAM and SPIFFS footprint</b></font></h2>
<p class="p5"><font class="f6"></font><br /></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How do I minimise the footprint of an application?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Perhaps the simplest aspect of reducing the footprint of an application is to get its scope correct. The ESP8266 is an IoT device and not a general purpose system. It is typically used to attach real-world monitors, controls, etc. to an intranet and is therefore designed to implement functions that have limited scope. We commonly come across developers who are trying to treat the ESP8266 as a general purpose device and can't understand why their application can't run.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The simplest and safest way to use IoT devices is to control them through a dedicated general purpose system on the same network. This could be a low cost system such as a <a href="https://www.raspberrypi.org/"><font color="#87000f" class="f4">RaspberryPi (RPi)</font></a> server, running your custom code or an open source <a href="http://en.wikipedia.org/wiki/home%20automation"><font color="#87000f" class="f4">home automation (HA)</font></a> application. Such systems have orders of magnitude more capacity than the ESP8266, for example the RPi has 2GB RAM and its SD card can be up to 32GB in capacity, and it can support the full range of USB-attached disk drives and other devices. It also runs a fully featured Linux OS, and has a rich selection of applications pre configured for it. There are plenty of alternative systems available in this under $50 price range, as well as proprietary HA systems which can cost 10-50 times more.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Using a tiered approach where all user access to the ESP8266 is passed through a controlling server means that the end-user interface (or smartphone connector), together with all of the associated validation and security can be implemented on a system designed to have the capacity to do this. This means that you can limit the scope of your ESP8266 application to a limited set of functions being sent to or responding to requests from this system.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"><i></i></font><font face="Arial" size="4" color="#333333" class="f2"><i>If you are trying to implement a user-interface or HTTP webserver in your ESP8266 then you are really abusing its intended purpose. When it comes to scoping your ESP8266 applications, the adage </i><b><i>K</i></b><i>eep </i><b><i>I</i></b><i>t </i><b><i>S</i></b><i>imple </i><b><i>S</i></b><i>tupid truly applies.</i><br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How do I minimise the footprint of an application on the file system</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">It is possible to write Lua code in a very compact format which is very dense in terms of functionality per KB of source code.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">However if you do this then you will also find it extremely difficult to debug or maintain your application.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">A good compromise is to use a tool such as <a href="http://luaforge.net/projects/luasrcdiet/"><font color="#87000f" class="f4">LuaSrcDiet</font></a>, which you can use to compact production code for downloading to the ESP8266:</font></li>
  <ul class="ul1">
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Keep a master repository of your code on your PC or a cloud-based versioning repository such as <a href="https://github.com/"><font color="#87000f" class="f4">GitHub</font></a><br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Lay it out and comment it for ease of maintenance and debugging<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Use a package such as <a href="https://github.com/4refr0nt/ESPlorer"><font color="#87000f" class="f4">Esplorer</font></a> to download modules that you are debugging and to test them.<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Once the code is tested and stable, then compress it using LuaSrcDiet before downloading to the ESP8266. Doing this will reduce the code footprint on the SPIFFS by 2-3x.<br />
</font></li>
  </ul>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Consider using </font><font face="Consolas" size="4" color="#333333" class="f5">node.compile()</font><font face="Arial" size="4" color="#333333" class="f2"> to pre-compile any production code. This removes the debug information from the compiled code reducing its size by roughly 40%. (However this is still perhaps 1.5-2x larger than a LuaSrcDiet-compressed source format, so if SPIFFS is tight then you might consider leaving less frequently run modules in Lua format. If you do a compilation, then you should consider removing the Lua source copy from file system as there's little point in keeping both on the ESP8266.<br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How do I minimise the footprint of running application?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The Lua Garbage collector is very aggressive at scanning and recovering dead resources. It uses an incremental mark-and-sweep strategy which means that any data which is not ultimately referenced back to the Globals table, the Lua registry or in-scope local variables in the current Lua code will be collected.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Setting any variable to </font><font face="Consolas" size="4" color="#333333" class="f5">nil</font><font face="Arial" size="4" color="#333333" class="f2"> dereferences the previous context of that variable. (Note that reference-based variables such as tables, strings and functions can have multiple variables referencing the same object, but once the last reference has been set to </font><font face="Consolas" size="4" color="#333333" class="f5">nil</font><font face="Arial" size="4" color="#333333" class="f2">, the collector will recover the storage.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Unlike other compile-on-load languages such as PHP, Lua compiled code is treated the same way as any other variable type when it comes to garbage collection and can be collected when fully dereferenced, so that the code-space can be reused.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Lua execution is intrinsically divided into separate event tasks with each bound to a Lua callback. This, when coupled with the strong dispose on dereference feature, means that it is very easy to structure your application using an classic technique which dates back to the 1950s known as <a href="http://en.wikipedia.org/wiki/Overlay%20(programming)"><font color="#87000f" class="f4">Overlays</font></a>.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Various approaches can be use to implement this. One is described by DP Whittaker in his <a href="http://www.esp8266.com/viewtopic.php?f=19&amp;t=1940"><font color="#87000f" class="f4">Massive memory optimization: flash functions</font></a> topic. Another is to use<i>volatile modules</i>. There are standard Lua templates for creating modules, but the </font><font face="Consolas" size="4" color="#333333" class="f5">require()</font><font face="Arial" size="4" color="#333333" class="f2"> library function creates a reference for the loaded module in the</font><font face="Consolas" size="4" color="#333333" class="f5">package.loaded</font><font face="Arial" size="4" color="#333333" class="f2"> table, and this reference prevents the module from being garbage collected. To make a module volatile, you should remove this reference to the loaded module by setting its corresponding entry in </font><font face="Consolas" size="4" color="#333333" class="f5">package.loaded</font><font face="Arial" size="4" color="#333333" class="f2"> to </font><font face="Consolas" size="4" color="#333333" class="f5">nil</font><font face="Arial" size="4" color="#333333" class="f2">. You can't do this in the outermost level of the module (since the reference is only created once execution has returned from the module code), but you can do it in any module function, and typically an initialisation function for the module, as in the following example:<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> s</font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">createServer</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">TCP</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span>s</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">listen</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#cc66cc" class="f10">80</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">require</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"connector"</font><font face="Consolas" size="4" color="#66cc66" class="f8">).</font><font face="Consolas" size="4" color="#333333" class="f7">init</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<ul class="ul1">
  <li class="li3"><font face="Consolas" size="4" color="#333333" class="f15"><b></b></font><font face="Consolas" size="4" color="#333333" class="f5"><b>connector.lua</b></font><font face="Arial" size="4" color="#333333" class="f2"> would be a standard module pattern except that the </font><font face="Consolas" size="4" color="#333333" class="f5">M.init()</font><font face="Arial" size="4" color="#333333" class="f2"> routine must include the lines<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> M</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7"> module </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#66cc66" class="f8">{},</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#66cc66" class="f8">...</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#333333" class="f7"> M</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">init</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">csocket</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">    </span>package</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">loaded</font><font face="Consolas" size="4" color="#66cc66" class="f8">[</font><font face="Consolas" size="4" color="#333333" class="f7">module</font><font face="Consolas" size="4" color="#66cc66" class="f8">]=</font><font face="Consolas" size="4" color="#993333" class="f13">nil</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">    </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">return</font><font face="Consolas" size="4" color="#333333" class="f7"> M<span class="Apple-converted-space"> </span></font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">This approach ensures that the module can be fully dereferenced on completion. OK, in this case, this also means that the module has to be reloaded on each TCP connection to port 80; however, loading a compiled module from SPIFFS only takes a few mSec, so surely this is an acceptable overhead if it enables you to break down your application into RAM-sized chunks. Note that </font><font face="Consolas" size="4" color="#333333" class="f5">require()</font><font face="Arial" size="4" color="#333333" class="f2"> will automatically search for </font><font face="Consolas" size="4" color="#333333" class="f5">connector.lc</font><font face="Arial" size="4" color="#333333" class="f2"> followed by </font><font face="Consolas" size="4" color="#333333" class="f5">connector.lua</font><font face="Arial" size="4" color="#333333" class="f2">, so the code will work for both source and compiled variants.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Whilst the general practice is for a module to return a table, [PiL 15.1] suggests that it is sometimes appropriate to return a single function instead as this avoids the memory overhead of an additional table. This pattern would look as follows:<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> s</font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">createServer</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">TCP</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span>s</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">listen</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#cc66cc" class="f10">80</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">require</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"connector"</font><font face="Consolas" size="4" color="#66cc66" class="f8">)(</font><font face="Consolas" size="4" color="#333333" class="f7">c</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> module </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#66cc66" class="f8">...</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- this is a situation where using an upvalue is essential!</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">return</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">csocket</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">    </span>package</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">loaded</font><font face="Consolas" size="4" color="#66cc66" class="f8">[</font><font face="Consolas" size="4" color="#333333" class="f7">module</font><font face="Consolas" size="4" color="#66cc66" class="f8">]=</font><font face="Consolas" size="4" color="#993333" class="f13">nil</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">    </span>module </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#993333" class="f13">nil</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">    </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Also note that you should <b><i>not</i></b> normally code this up listener call as the following because the RAM now has to accommodate both the module which creates the server <i>and</i> the connector logic.<br />
</font></li>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- . . .</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> s</font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">createServer</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">net</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">TCP</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> connector </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">require</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#ff0000" class="f12">"connector"</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#808080" class="f17"><i>-- don't do this unless you've got the RAM available!<span class="Apple-converted-space"> </span></i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">  </span>s</font><font face="Consolas" size="4" color="#66cc66" class="f8">:</font><font face="Consolas" size="4" color="#333333" class="f7">listen</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#cc66cc" class="f10">80</font><font face="Consolas" size="4" color="#66cc66" class="f8">,</font><font face="Consolas" size="4" color="#333333" class="f7">connector</font><font face="Consolas" size="4" color="#66cc66" class="f8">)</font><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span></font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How do I reduce the size of my compiled code?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Note that there are two methods of saving compiled Lua to SPIFFS:</font></p>
<ol class="ol1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The first is to use </font><font face="Consolas" size="4" color="#333333" class="f5">node.compile()</font><font face="Arial" size="4" color="#333333" class="f2"> on the </font><font face="Consolas" size="4" color="#333333" class="f5">.lua</font><font face="Arial" size="4" color="#333333" class="f2"> source file, which generates the equivalent bytecode </font><font face="Consolas" size="4" color="#333333" class="f5">.lc</font><font face="Arial" size="4" color="#333333" class="f2"> file. This approach strips out all the debug line and variable information.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The second is to use </font><font face="Consolas" size="4" color="#333333" class="f5">loadfile()</font><font face="Arial" size="4" color="#333333" class="f2"> to load the source file into memory, followed by </font><font face="Consolas" size="4" color="#333333" class="f5">string.dump()</font><font face="Arial" size="4" color="#333333" class="f2"> to convert it in-memory to a serialised load format which can then be written back to a </font><font face="Consolas" size="4" color="#333333" class="f5">.lc</font><font face="Arial" size="4" color="#333333" class="f2"> file. This approach creates a bytecode file which retains the debug information.<br />
</font></li>
</ol>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">The memory footprint of the bytecode created by method (2) is the same as when executing source files directly, but the footprint of bytecode created by method (1) is typically <b>60% of this size</b>, because the debug information is almost as large as the code itself. So using </font><font face="Consolas" size="4" color="#333333" class="f5">.lc</font><font face="Arial" size="4" color="#333333" class="f2"> files generated by </font><font face="Consolas" size="4" color="#333333" class="f5">node.compile()</font><font face="Arial" size="4" color="#333333" class="f2"> considerably reduces code size in memory – albeit with the downside that any runtime errors are extremely limited.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">In general consider method (1) if you have stable production code that you want to run in as low a RAM footprint as possible. Yes, method (2) can be used if you are still debugging, but you will probably be changing this code quite frequently, so it is easier to stick with </font><font face="Consolas" size="4" color="#333333" class="f5">.lua</font><font face="Arial" size="4" color="#333333" class="f2"> files for code that you are still developing.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Note that if you use </font><font face="Consolas" size="4" color="#333333" class="f5">require(“XXX”)</font><font face="Arial" size="4" color="#333333" class="f2"> to load your code then this will automatically search for </font><font face="Consolas" size="4" color="#333333" class="f5">XXX.lc</font><font face="Arial" size="4" color="#333333" class="f2"> then </font><font face="Consolas" size="4" color="#333333" class="f5">XXX.lua</font><font face="Arial" size="4" color="#333333" class="f2"> so you don't need to include the conditional logic to load the bytecode version if it exists, falling back to the source version otherwise.</font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How do I get a feel for how much memory my functions use?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">You should get an overall understanding of the VM model if you want to make good use of the limited resources available to Lua applications. An essential reference here is <a href="http://luaforge.net/docman/83/98/ANoFrillsIntroToLua51VMInstructions.pdf"><font color="#87000f" class="f4">A No Frills Introduction to Lua 5.1 VM Instructions</font></a> . This explain how the code generator works, how much memory overhead is involved with each table, function, string etc..<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">You can't easily get a bytecode listing of your ESP8266 code; however there are two broad options for doing this:</font></li>
  <ul class="ul1">
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"><b></b></font><font face="Arial" size="4" color="#333333" class="f2"><b>Generate a bytecode listing on your development PC</b>. The Lua 5.1 code generator is basically the same on the PC and on the ESP8266, so whilst it isn't identical, using the standard Lua batch compiler </font><font face="Consolas" size="4" color="#333333" class="f5">luac</font><font face="Arial" size="4" color="#333333" class="f2"> against your source on your PC with the </font><font face="Consolas" size="4" color="#333333" class="f5">-l -s</font><font face="Arial" size="4" color="#333333" class="f2"> option will give you a good idea of what your code will generate. The main difference between these two variants is the size_t for ESP8266 is 4 bytes rather than the 8 bytes size_t found on modern 64bit development PCs; and the eLua variants generate different access references for ROM data types. If you want to see what the </font><font face="Consolas" size="4" color="#333333" class="f5">string.dump()</font><font face="Arial" size="4" color="#333333" class="f2"> version generates then drop the </font><font face="Consolas" size="4" color="#333333" class="f5">-s</font><font face="Arial" size="4" color="#333333" class="f2"> option to retain the debug information.<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"><b></b></font><font face="Arial" size="4" color="#333333" class="f2"><b>Upload your </b></font><font face="Consolas" size="4" color="#333333" class="f5"><b>.lc</b></font><font face="Arial" size="4" color="#333333" class="f2"><b> files to the PC and disassemble then there</b>. There are a number of Lua code disassemblers which can list off the compiled code that you application modules will generate, </font><font face="Consolas" size="4" color="#333333" class="f5">if</font><font face="Arial" size="4" color="#333333" class="f2"> you have a script to upload files from your ESP8266 to your development PC. I use <a href="http://luaforge.net/projects/chunkspy/"><font color="#87000f" class="f4">ChunkSpy</font></a> which can be downloaded<a href="http://files.luaforge.net/releases/chunkspy/chunkspy/ChunkSpy-0.9.8/ChunkSpy-0.9.8.zip"><font color="#87000f" class="f4">here</font></a> , but you will need to apply the following patch so that ChunkSpy understands eLua data types:<br />
</font></li>
  </ul>
</ul>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>--- a/ChunkSpy-0.9.8/</font><font face="Consolas" size="4" color="#cc66cc" class="f10">5.1</font><font face="Consolas" size="4" color="#333333" class="f7">/ChunkSpy.lua <span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#cc66cc" class="f10">2015</font><font face="Consolas" size="4" color="#333333" class="f7">-05-04 </font><font face="Consolas" size="4" color="#cc66cc" class="f10">12</font><font face="Consolas" size="4" color="#333333" class="f7">:</font><font face="Consolas" size="4" color="#cc66cc" class="f10">39</font><font face="Consolas" size="4" color="#333333" class="f7">:</font><font face="Consolas" size="4" color="#cc66cc" class="f10">01.267975498</font><font face="Consolas" size="4" color="#333333" class="f7"> +0100</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>+++ b/ChunkSpy-0.9.8/</font><font face="Consolas" size="4" color="#cc66cc" class="f10">5.1</font><font face="Consolas" size="4" color="#333333" class="f7">/ChunkSpy.lua <span class="Apple-converted-space">  </span></font><font face="Consolas" size="4" color="#cc66cc" class="f10">2015</font><font face="Consolas" size="4" color="#333333" class="f7">-05-04 </font><font face="Consolas" size="4" color="#cc66cc" class="f10">12</font><font face="Consolas" size="4" color="#333333" class="f7">:</font><font face="Consolas" size="4" color="#cc66cc" class="f10">35</font><font face="Consolas" size="4" color="#333333" class="f7">:</font><font face="Consolas" size="4" color="#cc66cc" class="f10">59.623983095</font><font face="Consolas" size="4" color="#333333" class="f7"> +0100</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>@@ -</font><font face="Consolas" size="4" color="#cc66cc" class="f10">2193</font><font face="Consolas" size="4" color="#333333" class="f7">,</font><font face="Consolas" size="4" color="#cc66cc" class="f10">6</font><font face="Consolas" size="4" color="#333333" class="f7"> +</font><font face="Consolas" size="4" color="#cc66cc" class="f10">2193</font><font face="Consolas" size="4" color="#333333" class="f7">,</font><font face="Consolas" size="4" color="#cc66cc" class="f10">9</font><font face="Consolas" size="4" color="#333333" class="f7"> @@</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">            </span>config.AUTO_DETECT = true</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">          </span>elseif a == "--brief" then</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">            </span>config.DISPLAY_BRIEF = true</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>+<span class="Apple-converted-space">        </span>elseif a == "--elua" then</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>+<span class="Apple-converted-space">          </span>config.LUA_TNUMBER = </font><font face="Consolas" size="4" color="#cc66cc" class="f10">5</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space"> </span>+<span class="Apple-converted-space">          </span>config.LUA_TSTRING = </font><font face="Consolas" size="4" color="#cc66cc" class="f10">6</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">          </span>elseif a == "--interact" then</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7"><span class="Apple-converted-space">            </span>perform = ChunkSpy_Interact</font></p>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Your other great friend is to use </font><font face="Consolas" size="4" color="#333333" class="f5">node.heap()</font><font face="Arial" size="4" color="#333333" class="f2"> regularly through your code.<br />
</font></li>
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Use these tools and play with coding approaches to see how many instructions each typical line of code takes in your coding style. The Lua Wiki gives some general<a href="http://en.wikipedia.org/wiki/Program%20optimization"><font color="#87000f" class="f4">optimisation</font></a> tips, but in general just remember that these focus on optimising for execution speed and you will be interested mainly in optimising for code and variable space as these are what consumes precious RAM.<br />
</font></li>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>What is the cost of using functions?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Consider the output of </font><font face="Consolas" size="4" color="#333333" class="f5">dofile(“test1a.lua”)</font><font face="Arial" size="4" color="#333333" class="f2"> on the following code compared to the equivalent where the function </font><font face="Consolas" size="4" color="#333333" class="f5">pnh()</font><font face="Arial" size="4" color="#333333" class="f2"> is removed and the extra </font><font face="Consolas" size="4" color="#333333" class="f5">print(heap())</font><font face="Arial" size="4" color="#333333" class="f2">statement is placed inline:</font></p>
<p class="p6"><font face="Consolas" size="4" color="#808080" class="f17"><i>-- test1b.lua</i></font></p>
<p class="p6"><font face="Consolas" size="4" color="#000066" class="f11">collectgarbage</font><font face="Consolas" size="4" color="#66cc66" class="f8">()</font></p>
<p class="p6"><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> heap </font><font face="Consolas" size="4" color="#66cc66" class="f8">=</font><font face="Consolas" size="4" color="#333333" class="f7"> node</font><font face="Consolas" size="4" color="#66cc66" class="f8">.</font><font face="Consolas" size="4" color="#333333" class="f7">heap</font></p>
<p class="p6"><font face="Consolas" size="4" color="#000066" class="f11">print</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">heap</font><font face="Consolas" size="4" color="#66cc66" class="f8">())</font></p>
<p class="p6"><font face="Consolas" size="4" color="#b1b100" class="f9">local</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">function</font><font face="Consolas" size="4" color="#333333" class="f7"> pnh</font><font face="Consolas" size="4" color="#66cc66" class="f8">()</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#000066" class="f11">print</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">heap</font><font face="Consolas" size="4" color="#66cc66" class="f8">())</font><font face="Consolas" size="4" color="#333333" class="f7"> </font><font face="Consolas" size="4" color="#b1b100" class="f9">end</font></p>
<p class="p6"><font face="Consolas" size="4" color="#333333" class="f7">pnh</font><font face="Consolas" size="4" color="#66cc66" class="f8">()</font></p>
<p class="p6"><font face="Consolas" size="4" color="#000066" class="f11">print</font><font face="Consolas" size="4" color="#66cc66" class="f8">(</font><font face="Consolas" size="4" color="#333333" class="f7">heap</font><font face="Consolas" size="4" color="#66cc66" class="f8">())</font></p>
<table cellspacing="0" cellpadding="0" class="t1">
  <tbody>
    <tr>
      <td valign="top" class="td11">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14"><b>Heap Value</b></font></p>
      </td>
      <td valign="top" class="td12">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14"><b>Function Call</b></font></p>
      </td>
      <td valign="top" class="td13">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14"><b>Inline</b></font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td14">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">1</font></p>
      </td>
      <td valign="top" class="td15">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">20712</font></p>
      </td>
      <td valign="top" class="td16">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">21064</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td14">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">2</font></p>
      </td>
      <td valign="top" class="td15">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">20624</font></p>
      </td>
      <td valign="top" class="td16">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">21024</font></p>
      </td>
    </tr>
    <tr>
      <td valign="top" class="td14">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">3</font></p>
      </td>
      <td valign="top" class="td15">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">20576</font></p>
      </td>
      <td valign="top" class="td16">
        <p class="p3"><font face="Arial" size="3" color="#000000" class="f14">21024</font></p>
      </td>
    </tr>
  </tbody>
</table>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Here bigger means less RAM used.</font></p>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">Of course you should still use functions to structure your code and encapsulate common repeated processing, but just bear in mind that each function definition has a relatively high overhead for its header record and stack frame (compared to the 20 odd KB RAM available). <i>So try to avoid overusing functions. If there are less than a dozen or so lines in the function then you should consider putting this code inline if it makes sense to do so.</i></font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>What other resources are available?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Install lua and luac on your development PC. This is freely available for Windows, Mac and Linux distributions, but we strongly suggest that you use Lua 5.1 to maintain source compatibility with ESP8266 code. This will allow you not only to unit test some modules on your PC in a rich development environment, but you can also use </font><font face="Consolas" size="4" color="#333333" class="f5">luac</font><font face="Arial" size="4" color="#333333" class="f2"> to generate a bytecode listing of your code and to validate new code syntactically before downloading to the ESP8266. This will also allow you to develop server-side applications and embedded applications in a common language.<br />
</font></li>
</ul>
<h2 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 21.0px"><font face="Arial" size="5" color="#333333" class="f1"><b>Firmware and Lua app development</b></font></h2>
<p class="p5"><font class="f6"></font><br /></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How to save memory?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">The NodeMCU development team recommends that you consider using a tailored firmware build, which only includes the modules that you plan to use before developing any Lua application. Once you have the ability to make and flash custom builds, the you also have the option of moving time sensitive or logic intensive code into your own custom module. Doing this can save a large amount of RAM as C code can be run directly from Flash memory. If you want an easy-to-use intermediate option then why note try the <a href="http://frightanic.com/nodemcu-custom-build"><font color="#87000f" class="f4">Cloud based nodeMCU custom build service</font></a>?.<br />
</font></li>
</ul>
<h2 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 21.0px"><font face="Arial" size="5" color="#333333" class="f1"><b>Hardware Specifics</b></font></h2>
<p class="p5"><font class="f6"></font><br /></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>Why file writes fail all the time on DEVKIT V1.0?</b></font></h3>
<ul class="ul1">
  <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">NodeMCU DEVKIT V1.0 uses ESP12-E-DIO(ESP-12-D) module. This module runs the Flash memory in <a href="http://www.esp8266.com/wiki/doku.php?id=nodemcu-unofficial-faq#what_s_the_different_between_dio_and_qio_mode"><font color="#87000f" class="f4">Dual IO SPI</font></a> (DIO) mode. This firmware will not be correctly loaded if you uses old flashtool version, and the filesystem will not work if you used a pre 0.9.6 firmware version (&lt;0.9.5) or old. The easiest way to resolve this problem s update all the firmware and flash tool to current version.</font></li>
  <ol class="ol1">
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Use the latest <a href="https://github.com/themadinventor/esptool"><font color="#87000f" class="f4">esptool.py</font></a> with DIO support and command option to flash firmware, or<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Use the latest <a href="https://github.com/nodemcu/nodemcu-flasher"><font color="#87000f" class="f4">NodeMCU flasher</font></a> with default option. (You must select the </font><font face="Consolas" size="4" color="#333333" class="f5">restore to default</font><font face="Arial" size="4" color="#333333" class="f2"> option in advanced menu tab), or<br />
</font></li>
    <li class="li3"><font face="Arial" size="4" color="#333333" class="f3"></font><font face="Arial" size="4" color="#333333" class="f2">Use the latest Espressif's flash tool – see <a href="http://bbs.espressif.com/viewtopic.php?f=5&amp;t=433"><font color="#87000f" class="f4">this Espressif forum topic</font></a> (without auto download support). Use DIO mode and 32M flash size option, and flash latest firmware to 0x00000. Before flashing firmware, remember to hold FLASH button, and press RST button once. Note that the new nodeMCU our firmware download tool, when released, will be capable of flashing firmware automatically without any button presses.<br />
</font></li>
  </ol>
</ul>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>What's the different between DIO and QIO mode?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">&lt;TODO&gt;</font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How to use DEVKIT V0.9 on Mac OS X?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">&lt;TODO&gt;</font></p>
<h3 style="margin: 0.0px 0.0px 12.0px 0.0px; line-height: 16.0px"><font face="Arial" size="4" color="#333333" class="f2"><b>How does DEVKIT use DTR and RTS enter download mode?</b></font></h3>
<p class="p2"><font face="Arial" size="4" color="#333333" class="f2">&lt;TODO&gt;</font></p>
</body>
</html>
